FROM registry.digitalocean.com/keibi/steampipe-plugin-aws:0.0.1 as aws
FROM registry.digitalocean.com/keibi/steampipe-plugin-azure:0.0.1 as azure
RUN ls /
FROM registry.digitalocean.com/keibi/steampipe-plugin-azuread:0.0.1 as azuread

FROM alpine:3.12

ARG USER=steampipe
ENV HOME /home/$USER

RUN apk add --no-cache --update git curl wget sudo

RUN /bin/sh -c "$(curl -fsSL https://raw.githubusercontent.com/turbot/steampipe/main/install.sh )"

COPY --from=aws /steampipe-plugin-aws.plugin ~/.steampipe/plugins/hub.steampipe.io/plugins/turbot/aws@latest/steampipe-plugin-aws.plugin
COPY --from=azure /steampipe-plugin-azure.plugin ~/.steampipe/plugins/hub.steampipe.io/plugins/turbot/aws@latest/steampipe-plugin-azure.plugin
COPY --from=azuread /steampipe-plugin-azuread.plugin ~/.steampipe/plugins/hub.steampipe.io/plugins/turbot/aws@latest/steampipe-plugin-azuread.plugin

RUN adduser -D $USER \
        && echo "$USER ALL=(ALL) NOPASSWD: ALL" > /etc/sudoers.d/$USER \
        && chmod 0440 /etc/sudoers.d/$USER

RUN git clone https://github.com/turbot/steampipe-mod-aws-compliance.git /steampipe-mod-aws-compliance

USER $USER
RUN steampipe plugin install steampipe

WORKDIR /steampipe-mod-aws-compliance
CMD [ "steampipe", "check", "all" ]
